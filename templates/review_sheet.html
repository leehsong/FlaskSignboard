{% extends "base.html" %}
{% block title %}간판 정보 검수기{% endblock %}
{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
  .list-card {
    border:1px solid #ddd; border-radius:6px; padding:8px 10px; margin-bottom:6px;
    display:flex; justify-content:space-between; align-items:center;
    background:#fff; cursor:pointer;
  }
  .list-card.active {background:#f2fffb; font-weight:bold;}
  #dongListView, #companyListView {max-height:320px; overflow-y:auto;}
  .sign-card {position: relative;}
  .sign-card img {width:100%; height:100px; object-fit:cover; border:1px solid #ccc; border-radius:6px;}
  .overlay-btns {
    position: absolute; top: 5px; right: 5px;
    display: none; flex-direction: column; gap: 4px;
  }
  .sign-card:hover .overlay-btns {display:flex;}
</style>

<div class="container-fluid py-3">
  <h4 class="mb-3">간판 정보 검수기</h4>

  <div class="row">
    <!-- 왼쪽 -->
    <div class="col-6">
      <div class="row">
        <div class="col-6">
          <h6>동 목록</h6>
          <div id="dongListView"></div>
        </div>
        <div class="col-6">
          <h6>회사 목록</h6>
          <div id="companyListView"></div>
        </div>
      </div>
      <div class="mt-3">
        <h6>네이버 거리뷰/지도</h6>
        <iframe id="roadviewFrame"
                width="100%"
                height="600"
                frameborder="0"
                style="border:0;"
                allowfullscreen>
        </iframe>
      </div>
    </div>

    <!-- 오른쪽 -->
    <div class="col-6">
      <div class="card mb-3">
        <div class="card-body">
          <h6>회사 정보</h6>
          <input id="cpnName" class="form-control form-control-sm mb-2" placeholder="회사명">
          <input id="cpnAddr" class="form-control form-control-sm mb-2" placeholder="도로명 주소">

          <label class="form-label small">검수 차수</label>
          <select id="companyRound" class="form-select form-select-sm mb-2">
            <option>1차</option><option>2차</option><option>3차</option>
            <option>4차</option><option>5차</option><option>6차</option>
          </select>
          <label class="form-label small">진행 상태</label>
          <select id="companyStatus" class="form-select form-select-sm mb-2">
            <option>검수요청</option><option>확인완료</option><option>전달완료</option>
          </select>
          <label class="form-label small">검수 메모</label>
          <textarea id="companyComment" class="form-control form-control-sm mb-2"
                    rows="2" placeholder="검수 요청 관련 코멘트를 입력하세요"></textarea>

          <!-- 버튼들 한 줄 배치 -->
          <div class="d-flex gap-2">
            <button id="btnUpdateAddr" class="btn btn-sm btn-outline-warning">주소 변경</button>
            <button id="btnUpdateRoadview" class="btn btn-sm btn-outline-success">거리뷰 URL 변경</button>
            <button id="btnSaveReview" class="btn btn-sm btn-outline-primary">검수 상태 저장</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <h6>간판 목록</h6>
          <div id="signList" class="row row-cols-2 g-2"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 주소 변경 모달 -->
<div class="modal fade" id="addrModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">회사 주소 변경</h5></div>
      <div class="modal-body">
        <input id="m_cpnName" class="form-control form-control-sm mb-2" placeholder="회사명">
        <input id="m_cpnAddr" class="form-control form-control-sm mb-2" placeholder="도로명 주소">
        <input id="m_cpnTel" class="form-control form-control-sm mb-2" placeholder="전화번호">
      </div>
      <div class="modal-footer">
        <button class="btn btn-success" id="btnSaveAddr">저장</button>
        <button class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
      </div>
    </div>
  </div>
</div>

<!-- 간판 수정 모달 -->
<div class="modal fade" id="signEditModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">간판 정보 수정</h5></div>
      <div class="modal-body">
        <form id="signEditForm">
          <input type="hidden" id="edit_i_info">
          <div class="mb-2"><label>종류</label><input id="edit_type" class="form-control"></div>
          <div class="mb-2"><label>분류</label><input id="edit_category" class="form-control"></div>
          <div class="mb-2"><label>규격(c_prn)</label><input id="edit_c_prn" class="form-control"></div>
          <div class="mb-2"><label>가로</label><input id="edit_width" class="form-control"></div>
          <div class="mb-2"><label>세로</label><input id="edit_height" class="form-control"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-success" onclick="saveSignEdit()">저장</button>
        <button class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
      </div>
    </div>
  </div>
</div>

<script>
(async function(){
  const ILLEGAL_BASE="/api/illegal";
  const COMPANY_BASE="/api/company";
  const MAP_BASE="/api/map";
  const REVIEW_BASE="/api/review";
  const SIGN_BASE="/api/sign";
  let state={dong:null,companies:[],company:null};

  async function jget(url){const r=await fetch(url);return r.json();}
  async function jpost(url,body){const r=await fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});return r.json();}

  // 동 목록 + 검수 진행률
  async function loadDongs(){
    const dongs=await jget(`${ILLEGAL_BASE}/dongs`);
    const container=document.getElementById("dongListView"); container.innerHTML="";
    (dongs.dongs||[]).forEach(d=>{
      const div=document.createElement("div");
      div.className="list-card";
      div.innerHTML=`<span>${d}</span>`;
      div.onclick=()=>{container.querySelectorAll(".list-card").forEach(x=>x.classList.remove("active"));
                       div.classList.add("active"); selectDong(d);};
      container.appendChild(div);
    });
  }

  async function selectDong(d){
    state.dong=d;
    const data=await jget(`${ILLEGAL_BASE}/companies?dong=${encodeURIComponent(d)}`);
    state.companies=data.companies||[];
    renderCompanies();
  }

  function renderCompanies(){
    const container=document.getElementById("companyListView"); container.innerHTML="";
    state.companies.forEach(c=>{
      const div=document.createElement("div");
      div.className="list-card";
      div.textContent=`${c.company_name||"(무명)"} (${c.sign_count})`;
      div.onclick=()=>{container.querySelectorAll(".list-card").forEach(x=>x.classList.remove("active"));
                       div.classList.add("active"); openCompany(c.i_cpn,c.company_name);};
      container.appendChild(div);
    });
  }

  // 회사 열기
  window.openCompany=async function(i_cpn,name){
    state.company={i_cpn,company_name:name};
    document.getElementById("cpnName").value=name;

    try {
      const d=await jget(`${MAP_BASE}/roadview_url?i_cpn=${i_cpn}`);
      if(d.ok && d.url){
        document.getElementById("roadviewFrame").src=d.url;
      } else {
        document.getElementById("roadviewFrame").src="";
      }
    }catch(e){ console.warn("로드뷰 불러오기 실패:", e); }

    const signs=await jget(`${ILLEGAL_BASE}/all_signs?i_cpn=${i_cpn}`);
    renderSigns(signs.signs||[]);
  };

  // 주소 변경 버튼 → 모달
  document.getElementById("btnUpdateAddr").onclick=()=>{
    if(!state.company) return alert("회사를 먼저 선택하세요");
    document.getElementById("m_cpnName").value=document.getElementById("cpnName").value;
    document.getElementById("m_cpnAddr").value=document.getElementById("cpnAddr").value;
    new bootstrap.Modal(document.getElementById("addrModal")).show();
  };

  // 주소 저장
  document.getElementById("btnSaveAddr").onclick=async()=>{
    const fields={t_cpn:document.getElementById("m_cpnName").value,
                  t_road:document.getElementById("m_cpnAddr").value,
                  t_tel:document.getElementById("m_cpnTel").value};
    const res=await jpost(`${COMPANY_BASE}/update`,{i_cpn:state.company.i_cpn,fields});
    if(res.ok){ alert("주소 저장 완료"); bootstrap.Modal.getInstance(document.getElementById("addrModal")).hide();}
    else alert("실패: "+res.msg);
  };

  // 거리뷰 URL 저장
  document.getElementById("btnUpdateRoadview").onclick=async()=>{
    if(!state.company) return alert("회사를 먼저 선택하세요");
    const url=document.getElementById("roadviewFrame").src;
    if(!url) return alert("iframe에 로드뷰가 없습니다.");
    const res=await jpost(`${COMPANY_BASE}/update`,{i_cpn:state.company.i_cpn,fields:{navrv_url:url}});
    alert(res.ok?"로드뷰 URL 저장됨":"실패: "+res.msg);
  };

  // 검수 상태 저장
  document.getElementById("btnSaveReview").onclick=async()=>{
    if(!state.company) return alert("회사를 먼저 선택하세요");
    const body={i_cpn:state.company.i_cpn,
                round:document.getElementById("companyRound").value,
                status:document.getElementById("companyStatus").value,
                comment:document.getElementById("companyComment").value};
    const res=await jpost(`${REVIEW_BASE}/log`, body);
    alert(res.ok?"검수 상태 저장 완료":"실패: "+res.msg);
  };

  // 간판 목록 렌더링
  function renderSigns(signs){
    const list=document.getElementById("signList"); list.innerHTML="";
    signs.forEach(s=>{
      const col=document.createElement("div");
      col.className="col sign-card";
      col.innerHTML=`<img src="/api/sign/image_blob/${s.i_info}" onerror="this.src='';">`;
      list.appendChild(col);
    });
  }

  await loadDongs();
})();
</script>
{% endblock %}
