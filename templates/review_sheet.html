{% extends "base.html" %}
{% block title %}간판 정보 검수기{% endblock %}
{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
  .list-card {
    border:1px solid #ddd; border-radius:6px; padding:8px 10px; margin-bottom:6px;
    display:flex; justify-content:space-between; align-items:center;
    background:#fff; cursor:pointer;
  }
  .list-card.active {background:#f2fffb; font-weight:bold;}
  #dongListView, #companyListView {max-height:320px; overflow-y:auto;}
  .sign-card {position: relative;}
  .sign-card img {width:100%; height:100px; object-fit:cover; border:1px solid #ccc; border-radius:6px;}
  .overlay-btns {
    position: absolute; top: 5px; right: 5px;
    display: none; flex-direction: column; gap: 4px;
  }
  .sign-card:hover .overlay-btns {display:flex;}
</style>

<div class="container-fluid py-3">
  <h4 class="mb-3">간판 정보 검수기</h4>

  <div class="row">
    <!-- 왼쪽 -->
    <div class="col-6">
      <div class="row">
        <div class="col-6">
          <h6>동 목록</h6>
          <div id="dongListView"></div>
        </div>
        <div class="col-6">
          <h6>회사 목록</h6>
          <div id="companyListView"></div>
        </div>
      </div>
      <div class="mt-3">
        <h6>네이버 거리뷰/지도</h6>
        <iframe id="mapFrame" style="width:100%; height:340px; border:0;"></iframe>
      </div>
    </div>

    <!-- 오른쪽 -->
    <div class="col-6">
      <div class="card mb-3">
        <div class="card-body">
          <h6>회사 정보</h6>
          <input id="cpnName" class="form-control form-control-sm mb-2" placeholder="회사명">
          <input id="cpnAddr" class="form-control form-control-sm mb-2" placeholder="도로명 주소">

          <button id="btnUpdateAddr" class="btn btn-sm btn-outline-warning mb-2">주소 변경</button>

          <label class="form-label small">검수 차수</label>
          <select id="companyRound" class="form-select form-select-sm mb-2">
            <option>1차</option><option>2차</option><option>3차</option>
            <option>4차</option><option>5차</option><option>6차</option>
          </select>
          <label class="form-label small">진행 상태</label>
          <select id="companyStatus" class="form-select form-select-sm mb-2">
            <option>검수요청</option><option>확인완료</option><option>전달완료</option>
          </select>
          <label class="form-label small">검수 메모</label>
          <textarea id="companyComment" class="form-control form-control-sm mb-2"
                    rows="2" placeholder="검수 요청 관련 코멘트를 입력하세요"></textarea>

          <!-- 네이버 로드뷰 URL -->
          <label class="form-label small">네이버 로드뷰 URL</label>
          <input id="cpnRoadview" class="form-control form-control-sm mb-2" placeholder="로드뷰 URL">
          <button id="btnSaveRoadviewUrl" class="btn btn-sm btn-outline-success">로드뷰 URL 저장</button>

          <button id="btnSaveReview" class="btn btn-sm btn-outline-primary mt-2">검수 상태 저장</button>
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <h6>간판 목록</h6>
          <div id="signList" class="row row-cols-2 g-2"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 간판 수정 모달 -->
<div class="modal fade" id="signEditModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">간판 정보 수정</h5></div>
      <div class="modal-body">
        <form id="signEditForm">
          <input type="hidden" id="edit_i_info">
          <div class="mb-2"><label>종류</label><input id="edit_type" class="form-control"></div>
          <div class="mb-2"><label>분류</label><input id="edit_category" class="form-control"></div>
          <div class="mb-2"><label>규격(c_prn)</label><input id="edit_c_prn" class="form-control"></div>
          <div class="mb-2"><label>가로</label><input id="edit_width" class="form-control"></div>
          <div class="mb-2"><label>세로</label><input id="edit_height" class="form-control"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-success" onclick="saveSignEdit()">저장</button>
        <button class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
      </div>
    </div>
  </div>
</div>

<script>
(async function(){
  const ILLEGAL_BASE="/api/illegal";
  const COMPANY_BASE="/api/company";
  const MAP_BASE="/api/map";
  const REVIEW_BASE="/api/review";
  const SIGN_BASE="/api/sign";
  let state={dong:null,companies:[],company:null};

  async function jget(url){const r=await fetch(url);if(!r.ok)throw new Error(url);return r.json();}
  async function jpost(url,body){const r=await fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});if(!r.ok)throw new Error(url);return r.json();}

  // 동 목록 + 검수 진행률
  async function loadDongs(){
    const dongs=await jget(`${ILLEGAL_BASE}/dongs`);
    let stats={};
    try {
      const summary=await jget(`${REVIEW_BASE}/summary?kind=company`);
      (summary.rows||[]).forEach(r=>{stats[r.dong]=`${r.done||0}/${r.total||0}`;});
    }catch(e){}
    const container=document.getElementById("dongListView"); container.innerHTML="";
    (dongs.dongs||[]).forEach(d=>{
      const div=document.createElement("div");
      div.className="list-card";
      div.innerHTML=`<span>${d}</span><span class="badge bg-light text-dark">${stats[d]||""}</span>`;
      div.onclick=()=>{container.querySelectorAll(".list-card").forEach(x=>x.classList.remove("active"));
                       div.classList.add("active"); selectDong(d);};
      container.appendChild(div);
    });
  }

  async function selectDong(d){
    state.dong=d;
    const data=await jget(`${ILLEGAL_BASE}/companies?dong=${encodeURIComponent(d)}`);
    state.companies=data.companies||[];
    renderCompanies();
  }

  function renderCompanies(){
    const container=document.getElementById("companyListView"); container.innerHTML="";
    state.companies.forEach(c=>{
      const div=document.createElement("div");
      div.className="list-card";
      div.textContent=`${c.company_name||"(무명)"} (${c.sign_count})`;
      div.onclick=()=>{container.querySelectorAll(".list-card").forEach(x=>x.classList.remove("active"));
                       div.classList.add("active"); openCompany(c.i_cpn,c.company_name);};
      container.appendChild(div);
    });
  }

  window.openCompany=async function(i_cpn,name){
    state.company={i_cpn,company_name:name};
    document.getElementById("cpnName").value=name;
    try {
      const detail=await jget(`${COMPANY_BASE}/info/${i_cpn}`);
      if(detail.ok){
        const info=detail.info;
        document.getElementById("cpnAddr").value=info.t_road||"";
      }
    }catch(e){}
    // 저장된 로드뷰 URL 불러오기
    try {
      const saved=await jget(`${COMPANY_BASE}/mapurl?i_cpn=${i_cpn}`);
      if(saved && saved.navrv_url){
        document.getElementById("cpnRoadview").value=saved.navrv_url;
        document.getElementById("mapFrame").src=saved.navrv_url;
      }
    }catch(e){}
    const signs=await jget(`${ILLEGAL_BASE}/all_signs?i_cpn=${i_cpn}`);
    renderSigns(signs.signs||[]);
  };

  // 로드뷰 URL 저장
  document.getElementById("btnSaveRoadviewUrl").onclick=async()=>{
    if(!state.company) return alert("회사를 먼저 선택하세요");
    const url=document.getElementById("cpnRoadview").value.trim();
    if(!url) return alert("URL을 입력하세요");
    const body={i_cpn:state.company.i_cpn, fields:{navrv_url:url}};
    const res=await jpost(`${COMPANY_BASE}/update`, body);
    alert(res.ok? "로드뷰 URL 저장됨":"실패: "+res.msg);
  };

  function renderSigns(signs){
    const list=document.getElementById("signList"); list.innerHTML="";
    signs.slice(0,8).forEach(s=>{
      const col=document.createElement("div");
      col.className="col sign-card";
      col.innerHTML=`
        <img src="/api/sign/image_blob/${s.i_info}" onerror="this.src='';">
        <div class="overlay-btns">
          <button class="btn btn-sm btn-danger" onclick="deleteSign('${s.i_info}')">삭제</button>
          <button class="btn btn-sm btn-warning" onclick="openSignEdit('${s.i_info}')">수정</button>
        </div>
        <div class="small">분류: ${s.분류||'-'}</div>
        <div class="small">규격: ${s.c_prn||'-'}</div>`;
      list.appendChild(col);
    });
    const addCol=document.createElement("div");
    addCol.className="col";
    addCol.innerHTML=`<div class="card h-100 d-flex align-items-center justify-content-center"
                          style="cursor:pointer;" onclick="createDummySign()">
                        <span style="font-size:2rem;">＋</span>
                        <div class="small">간판 추가</div>
                      </div>`;
    list.appendChild(addCol);
  }

  // 간판 삭제
  window.deleteSign=async function(i_info){
    if(!confirm("간판을 삭제할까요?")) return;
    const res=await jpost(`${SIGN_BASE}/delete`,{i_info});
    alert(res.ok?"삭제 완료":"실패: "+res.msg);
    openCompany(state.company.i_cpn,state.company.company_name);
  };

  // 간판 수정 모달 열기
  window.openSignEdit=async function(i_info){
    try{
      const res=await jget(`${SIGN_BASE}/detail/${i_info}`);
      if(res.ok){
        const s=res.sign;
        document.getElementById("edit_i_info").value=s.i_info;
        document.getElementById("edit_type").value=s.type||"";
        document.getElementById("edit_category").value=s.category||"";
        document.getElementById("edit_c_prn").value=s.c_prn||"";
        document.getElementById("edit_width").value=s.width||"";
        document.getElementById("edit_height").value=s.height||"";
        new bootstrap.Modal(document.getElementById("signEditModal")).show();
      }
    }catch(e){alert("간판 정보를 불러오지 못했습니다");}
  };

  // 간판 수정 저장
  window.saveSignEdit=async function(){
    const body={
      i_info:document.getElementById("edit_i_info").value,
      fields:{
        sc_sbd:document.getElementById("edit_type").value,
        sc_sbc:document.getElementById("edit_category").value,
        q_img_w:document.getElementById("edit_width").value,
        q_img_h:document.getElementById("edit_height").value
      }
    };
    const res=await jpost(`${SIGN_BASE}/update`,body);
    if(res.ok){alert("간판 정보가 저장되었습니다.");openCompany(state.company.i_cpn,state.company.company_name);}
    else alert("저장 실패: "+(res.msg||""));
  };

  // 더미 간판 추가
  window.createDummySign=async function(){
    if(!state.company) return alert("회사를 먼저 선택하세요");
    const res=await jpost(`${SIGN_BASE}/create_dummy`,{i_cpn:state.company.i_cpn});
    if(res.ok){
      alert("더미 간판 추가 완료");
      openCompany(state.company.i_cpn,state.company.company_name);
    } else {
      alert("추가 실패: "+res.msg);
    }
  };

  await loadDongs();
})();
</script>
{% endblock %}
