<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Image Reviewer - ê²€ìˆ˜</title>
  <style>
    body { font-family: ui-sans-serif, system-ui; margin: 20px; }
    .wrap { display: grid; grid-template-columns: 1fr 360px; gap: 16px; }
    .pic { border: 1px solid #888; min-height: 480px; display: flex; align-items: center; justify-content: center; }
    .pic img { max-width: 100%; max-height: 80vh; }
    .meta { background: #f9f9f9; padding: 12px; border-radius: 8px; }
    .row { margin-top: 10px; }
    .btns button { height: 36px; margin-right: 6px; }
    .log { background: #fafafa; border: 1px solid #eee; padding: 8px; height: 100px; overflow: auto; white-space: pre-wrap; }
    .bar { display:flex; align-items:center; gap:12px; margin-bottom:12px; }
  </style>
</head>
<body>
  <div class="bar">
    <h2 id="title" style="margin:0;">ë¡œë”© ì¤‘â€¦</h2>
    <div style="color:#666;">ê²€ìˆ˜ì: <b>{{ reviewer }}</b></div>
    <a href="{{ url_for('duplicates_page') }}" target="_blank">ğŸ” company ì¤‘ë³µ í™•ì¸</a>
  </div>

  <div class="wrap">
    <div class="pic">
      <img id="photo" alt="ì´ë¯¸ì§€" />
    </div>
    <div>
      <div class="meta" id="meta">ë©”íƒ€ ë¡œë”©â€¦</div>

      <div class="row btns" style="margin-top:12px;">
        <button onclick="nav(-1)">â—€ ì´ì „</button>
        <button onclick="nav(+1)">ë‹¤ìŒ â–¶</button>
      </div>

      <div class="row btns">
        <button onclick="save('Y')">âœ… ì •ìƒ(Y)</button>
        <button onclick="save('N')">âŒ ë¶ˆëŸ‰(N)</button>
        <button onclick="save('U')">ğŸ•— ìœ ë³´(U)</button>
        <button onclick="openFolder()">ğŸ“‚ í´ë”(ë¡œì»¬ ë¶ˆê°€)</button>
        <button onclick="openMap()">ğŸ—ºï¸ ì§€ë„</button>
      </div>

      <div class="row">
        <textarea id="memo" placeholder="ê²€ìˆ˜ ì˜ê²¬â€¦" rows="4" style="width:100%;"></textarea>
      </div>

      <div class="row log" id="log"></div>
    </div>
  </div>

<script>
let curIndex = 0, total = 0, curId = '', curAddrFull = '';

function log(msg){
  const t = new Date().toLocaleTimeString();
  const div = document.getElementById('log');
  const lines = div.textContent.split('\n').slice(-20);
  lines.push(`[${t}] ${msg}`);
  div.textContent = lines.join('\n').trim();
}

async function init(){
  const s = await fetch('/api/state').then(r=>r.json());
  curIndex = s.index; total = s.total;
  await loadAt(curIndex);
}

async function loadAt(index){
  const meta = await fetch(`/api/meta/${index}`).then(r=>r.json());
  if(meta.error){ alert(meta.error); return; }
  curId = meta.id;
  curAddrFull = meta.addr_full || '';
  document.getElementById('meta').innerHTML = meta.meta_html;
  document.getElementById('title').textContent = `${curId}  (${index+1}/${total})`;
  document.getElementById('memo').value = '';
  document.getElementById('photo').src = `/api/image_blob/${curId}`;
  curIndex = index;
  log(`ë¡œë“œ: ${curId}`);
}

async function nav(step){
  const res = await fetch('/api/nav', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({step})
  }).then(r=>r.json());
  await loadAt(res.index);
}

async function save(result){
  const comment = document.getElementById('memo').value.trim();
  const res = await fetch('/api/review', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ad_idx: curId, result, comment})
  }).then(r=>r.json());
  if(res.ok){ log(`ì €ì¥: ${curId} â†’ ${result}`); }
  else { alert(res.msg || 'ì €ì¥ ì‹¤íŒ¨'); }
}

function openFolder(){
  alert('ì›¹ í™˜ê²½ì—ì„œëŠ” ë¡œì»¬ í´ë” ì§ì ‘ ì—´ê¸°ê°€ ë¶ˆê°€í•©ë‹ˆë‹¤.');
}

async function openMap(){
  const u = await fetch(`/api/map_url/${curIndex}`).then(r=>r.json());
  if(u.url){ window.open(u.url, '_blank'); }
}
init();
</script>
</body>
</html>
