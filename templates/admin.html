<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>ê´€ë¦¬ì ìŠ¹ì¸/ë°˜ë ¤</title>
  <style>
    body { font-family: ui-sans-serif, system-ui; margin: 20px; }
    .top { display:flex; align-items:center; gap:12px; }
    .muted { color:#666; }
    .wrap { display:grid; grid-template-columns: 820px 1fr; gap:16px; margin-top:12px; }
    .imgbox { border:1px solid #ddd; min-height: 600px; display:flex; align-items:center; justify-content:center; }
    .imgbox img { max-width: 800px; max-height: 600px; }
    .panel { border:1px solid #ddd; border-radius: 8px; padding:12px; }
    .list { max-height: 220px; overflow:auto; border:1px solid #eee; border-radius:6px; }
    .row { margin-top:10px; }
    textarea { width:100%; height:110px; padding:8px; }
    button { padding:8px 12px; }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom:1px solid #f0f0f0; padding:6px 8px; text-align:left; }
    th { background:#fafafa; }
  </style>
</head>
<body>
  <div class="top">
    <h2 style="margin:0;">ğŸ›‚ ê´€ë¦¬ì ìŠ¹ì¸/ë°˜ë ¤</h2>
    <div class="muted">ê´€ë¦¬ì: <b>{{ admin }}</b></div>
    <a href="{{ url_for('home') }}" style="margin-left:auto;">â† í™ˆ</a>
  </div>

  <div class="wrap">
    <!-- ì¢Œ: ì´ë¯¸ì§€ -->
    <div class="imgbox">
      <img id="photo" alt="ì´ë¯¸ì§€" />
    </div>

    <!-- ìš°: ì •ë³´/ì•¡ì…˜ -->
    <div class="panel">
      <div class="row">
        <b>ëŒ€ê¸° ëª©ë¡</b>
        <div class="muted">í˜ì´ì§€: <span id="pageInfo"></span></div>
        <div class="list" id="pendingList"></div>
        <div class="row">
          <button onclick="prevPage()">ì´ì „</button>
          <button onclick="nextPage()">ë‹¤ìŒ</button>
        </div>
      </div>

      <div class="row" style="margin-top:14px;">
        <b>ì„ íƒ í•­ëª©</b>
        <div id="meta" class="muted">ëª©ë¡ì—ì„œ í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.</div>
      </div>

      <div class="row">
        <label>ê´€ë¦¬ì ì½”ë©˜íŠ¸</label>
        <textarea id="adminCmt" placeholder="ë°˜ë ¤ ì‚¬ìœ  ë“± ë©”ëª¨"></textarea>
      </div>

      <div class="row" style="display:flex; gap:8px;">
        <button onclick="decision('A')">âœ… ìŠ¹ì¸(A)</button>
        <button onclick="decision('R')">âŒ ë°˜ë ¤(R)</button>
      </div>
    </div>
  </div>

<script>
let page=1, per_page=20, total=0, items=[], current=null;

async function loadPage(p=1){
  const res = await fetch(`/admin/api/pending?page=${p}&per_page=${per_page}`).then(r=>r.json());
  if(res.error){ alert(res.error); return; }
  page = res.page; per_page = res.per_page; total = res.total; items = res.items || [];
  document.getElementById('pageInfo').textContent = `${page} / ${Math.max(1, Math.ceil(total/per_page))} (ì´ ${total}ê±´)`;
  renderList();
  if(items.length){ select(items[0]); } else { clearView(); }
}

function renderList(){
  const el = document.getElementById('pendingList'); el.innerHTML='';
  if(!items.length){ el.textContent = 'ëŒ€ê¸° í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.'; return; }
  const tbl = document.createElement('table');
  const thead = document.createElement('thead');
  thead.innerHTML = '<tr><th>i_img</th><th>ê²€ìˆ˜ì</th><th>ê²°ê³¼</th><th>ê²€ìˆ˜ì¼</th></tr>';
  tbl.appendChild(thead);
  const tb = document.createElement('tbody');
  for(const it of items){
    const tr = document.createElement('tr');
    tr.style.cursor='pointer';
    tr.onclick = ()=>select(it);
    tr.innerHTML = `<td>${it.i_img}</td><td>${it.c_reviewer||''}</td><td>${it.c_verify||''}</td><td>${(it.d_verify||'').replace('T',' ').slice(0,19)}</td>`;
    tb.appendChild(tr);
  }
  tbl.appendChild(tb); el.appendChild(tbl);
}

function clearView(){
  current = null;
  document.getElementById('photo').src = '';
  document.getElementById('meta').innerHTML = 'ëª©ë¡ì—ì„œ í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.';
  document.getElementById('adminCmt').value = '';
}

function select(it){
  current = it;
  document.getElementById('photo').src = `/api/image_by_iimg/${encodeURIComponent(it.i_img)}`;
  document.getElementById('meta').innerHTML =
    `<div><b>ì´ë¯¸ì§€:</b> ${it.i_img}</div>
     <div><b>ê²€ìˆ˜ì:</b> ${it.c_reviewer||''}</div>
     <div><b>ê²°ê³¼:</b> ${it.c_verify||''}</div>
     <div><b>ì½”ë©˜íŠ¸:</b><br>${(it.t_comment||'').replaceAll('\n','<br>')}</div>`;
  document.getElementById('adminCmt').value = '';
}

async function decision(dec){
  if(!current){ alert('í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.'); return; }
  const comment = document.getElementById('adminCmt').value.trim();
  const res = await fetch('/admin/api/decision', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ i_img: current.i_img, decision: dec, comment })
  }).then(r=>r.json());
  if(res.ok){
    // ë¦¬ìŠ¤íŠ¸ì—ì„œ ì œê±° í›„ í™”ë©´ ê°±ì‹ 
    items = items.filter(x=>x.i_img !== current.i_img);
    if(items.length){ select(items[0]); renderList(); }
    else { // í˜„ì¬ í˜ì´ì§€ê°€ ë¹„ì—ˆìœ¼ë©´ ë‹¤ìŒ í˜ì´ì§€ ë¡œë”© ì‹œë„
      const maxPage = Math.max(1, Math.ceil((total-1)/per_page));
      const nextP = Math.min(page, maxPage);
      await loadPage(nextP);
    }
  }else{
    alert('ì €ì¥ ì‹¤íŒ¨: ' + (res.msg||''));
  }
}

function prevPage(){ if(page>1) loadPage(page-1); }
function nextPage(){ const maxPage = Math.max(1, Math.ceil(total/per_page)); if(page<maxPage) loadPage(page+1); }
loadPage(1);
</script>
</body>
</html>
