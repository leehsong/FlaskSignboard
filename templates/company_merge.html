{% extends "base.html" %}
{% block title %}회사/간판 병합 및 관리{% endblock %}

{% block content %}
<div class="container-fluid py-5">
  <div class="row gx-4">

    <!-- 동 선택 -->
    <div class="col-lg-3">
      <h5>동 목록</h5>
      <div class="list-group" id="dongList" style="max-height:400px; overflow-y:auto;">
        <div class="list-group-item">동 목록 불러오는 중...</div>
      </div>
    </div>

    <!-- 번지 선택 -->
    <div class="col-lg-3">
      <h5>번지 목록</h5>
      <div class="list-group" id="bunjiList" style="max-height:400px; overflow-y:auto;">
        <div class="list-group-item">동을 먼저 선택하세요.</div>
      </div>
    </div>

    <!-- 회사 목록 + 정보 -->
    <div class="col-lg-3">
      <h5>회사 목록</h5>
      <div class="list-group" id="companyList" style="max-height:200px; overflow-y:auto;">
        <div class="list-group-item">동/번지를 먼저 선택하세요.</div>
      </div>

      <h5 class="mt-4">회사 정보</h5>
      <div id="companyInfo">
        <div class="card"><div class="card-body"><p>회사 선택 시 정보가 표시됩니다.</p></div></div>
      </div>

      <div class="mt-3">
        <button id="mergeBtn" class="btn btn-mint w-100" disabled>선택된 회사 병합하기</button>
      </div>
    </div>

    <!-- 간판 정보 -->
    <div class="col-lg-3">
      <h5>간판 정보</h5>
      <div id="signInfo" class="row g-2">
        <div class="text-muted">회사 선택 시 간판 정보가 표시됩니다.</div>
      </div>
    </div>

  </div>
</div>

<!-- 간판 이미지 모달 -->
<div class="modal fade" id="signModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-body text-center">
        <img id="modalImage" src="" class="img-fluid mb-3" alt="간판 이미지">
        <form id="replaceForm" enctype="multipart/form-data">
          <input type="file" name="image" accept="image/*" class="form-control mb-2">
          <input type="hidden" name="i_info" id="modalIInfo">
          <button type="submit" class="btn btn-primary">이미지 교체</button>
        </form>
        <div class="d-flex justify-content-around mt-3">
          <a id="historyBtn" class="btn btn-outline-secondary btn-sm" target="_blank">🖼 이미지 히스토리</a>
          <button type="button" class="btn btn-outline-info btn-sm" id="cropBtn">✂ 이미지 수정</button>
          <button type="button" class="btn btn-outline-success btn-sm" id="findDongBtn">🔍 동/번지 이미지 찾기</button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock content %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.css" rel="stylesheet"/>

<script>
// --- 코드 → 한글 매핑 ---
const SBF_MAP = {
  "SBF01": "허가","SBF02": "신고","SBF03": "허가신고배제",
  "SBF04": "무허가요건구비","SBF06": "무신고요건구비",
  "SBF08": "요건불비(수량초과)","SBF09": "요건불비(위치장소위반)",
  "SBF10": "요건불비(규격위반)","SBF11": "요건불비(표시방법위반)"
};
const SBD_MAP = {
  "SBD1": "전광(간접조명)","SBD2": "네온사인","SBD3": "일반전기",
  "SBD4": "화공","SBD5": "비조명","SBD6": "간접조명","SBD9": "기타재료"
};
const SBC_MAP = {
  "SBC01": "가로형간판","SBC02": "세로형간판","SBC03": "돌출간판",
  "SBC05": "옥상간판","SBC06": "지주이용간판","SBC11": "공공시설물이용",
  "SBC13": "교통수단이용","SBC21": "현수막게시틀"
};

// --- 공용 select 렌더링 함수 ---
function renderSelect(selectId, codes, map) {
  const sel = document.getElementById(selectId);
  sel.innerHTML = "";
  codes.forEach(code => {
    const opt = document.createElement("option");
    opt.value = code;
    opt.textContent = map[code] || code;
    sel.appendChild(opt);
  });
}

// === 예시: 간판 등록 폼에서 코드 목록 불러오기 ===
fetch("/api/codes/sbf").then(r=>r.json()).then(d=>{
  renderSelect("sbfSelect", d.codes, SBF_MAP);
});
fetch("/api/codes/sbd").then(r=>r.json()).then(d=>{
  renderSelect("sbdSelect", d.codes, SBD_MAP);
});
fetch("/api/codes/sbc").then(r=>r.json()).then(d=>{
  renderSelect("sbcSelect", d.codes, SBC_MAP);
});

// === 이미지 모달 동작 ===
let currentIInfo=null, cropper=null;
document.getElementById("replaceForm").addEventListener("submit", e=>{
  e.preventDefault();
  const fd=new FormData(e.target);
  fetch("/api/sign/image_replace",{method:"POST",body:fd})
    .then(r=>r.json()).then(d=>{
      if(d.ok){ alert("이미지 교체 완료"); bootstrap.Modal.getInstance(document.getElementById("signModal")).hide(); }
      else alert("실패: "+d.msg);
    });
});
</script>
{% endblock scripts %}
