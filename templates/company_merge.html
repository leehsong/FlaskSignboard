{% extends "base.html" %}
{% block title %}íšŒì‚¬ ë³‘í•©{% endblock %}

{% block content %}
<div class="container-fluid py-5">
  <div class="row gx-4">

    <!-- 1ë‹¨: ë™ ì„ íƒ -->
    <div class="col-lg-3">
      <h5>ë™ ëª©ë¡</h5>
      <div class="list-group" id="dongList" style="max-height:400px; overflow-y:auto;">
        <div class="list-group-item">ë™ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>
    </div>

    <!-- 2ë‹¨: ë²ˆì§€ ì„ íƒ -->
    <div class="col-lg-3">
      <h5>ë²ˆì§€ ëª©ë¡</h5>
      <div class="list-group" id="bunjiList" style="max-height:400px; overflow-y:auto;">
        <div class="list-group-item">ë™ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.</div>
      </div>
    </div>

    <!-- 3ë‹¨: íšŒì‚¬ ëª©ë¡ + ì •ë³´ -->
    <div class="col-lg-3">
      <h5>íšŒì‚¬ ëª©ë¡</h5>
      <div class="list-group" id="companyList" style="max-height:200px; overflow-y:auto;">
        <div class="list-group-item">ë™/ë²ˆì§€ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.</div>
      </div>

      <h5 class="mt-4">íšŒì‚¬ ì •ë³´</h5>
      <div id="companyInfo">
        <div class="card">
          <div class="card-body">
            <p>íšŒì‚¬ ì„ íƒ ì‹œ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
          </div>
        </div>
      </div>

      <div class="mt-3">
        <button id="mergeBtn" class="btn btn-mint w-100" disabled>ì„ íƒëœ íšŒì‚¬ ë³‘í•©í•˜ê¸°</button>
      </div>
    </div>

    <!-- 4ë‹¨: ê°„íŒ ì •ë³´ -->
    <div class="col-lg-3">
      <h5>ê°„íŒ ì •ë³´</h5>
      <div id="signInfo" class="row g-2">
        <div class="text-muted">íšŒì‚¬ ì„ íƒ ì‹œ ê°„íŒ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
      </div>
    </div>

  </div>
</div>

<!-- Modal: í° ì´ë¯¸ì§€ ë³´ê¸° & êµì²´/ìˆ˜ì • -->
<div class="modal fade" id="signModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-body text-center">
        <img id="modalImage" src="" class="img-fluid mb-3" alt="ê°„íŒ ì´ë¯¸ì§€">
        <form id="replaceForm" enctype="multipart/form-data">
          <input type="file" name="image" accept="image/*" class="form-control mb-2">
          <input type="hidden" name="i_info" id="modalIInfo">
          <button type="submit" class="btn btn-primary">ì´ë¯¸ì§€ êµì²´</button>
        </form>
        <div class="d-flex justify-content-around mt-3">
          <a id="historyBtn" class="btn btn-outline-secondary btn-sm" target="_blank">ğŸ–¼ ì´ë¯¸ì§€ íˆìŠ¤í† ë¦¬</a>
          <button type="button" class="btn btn-outline-info btn-sm" id="cropBtn">âœ‚ ì´ë¯¸ì§€ ìˆ˜ì •</button>
          <button type="button" class="btn btn-outline-success btn-sm" id="findDongBtn">ğŸ” ë™/ë²ˆì§€ ì°¾ê¸°</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Crop 4:3 -->
<div class="modal fade" id="cropModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-body text-center">
        <img id="cropImage" src="" class="img-fluid">
      </div>
      <div class="modal-footer d-flex justify-content-between">
        <div>
          <button id="rotateLeftBtn" class="btn btn-outline-secondary btn-sm">âŸ² ì¢ŒíšŒì „</button>
          <button id="rotateRightBtn" class="btn btn-outline-secondary btn-sm">âŸ³ ìš°íšŒì „</button>
        </div>
        <button id="cropSaveBtn" class="btn btn-success">ì €ì¥</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: ë™/ë²ˆì§€ ì´ë¯¸ì§€ ì„ íƒ -->
<div class="modal fade" id="dongModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-body" id="dongImages" style="max-height:500px; overflow-y:auto;">
        <!-- JSë¡œ ì±„ì›€ -->
      </div>
    </div>
  </div>
</div>
{% endblock content %}

{% block scripts %}
<style>
.list-group-item.active {
  background-color: #20c997;
  color: #000 !important;
}
</style>

<!-- CropperJS -->
<script src="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.css" rel="stylesheet"/>

<script>
let currentIInfo = null;
let cropper = null;

// --- ë™ ëª©ë¡ (ê²€ìˆ˜í˜„í™© í¬í•¨) ---
fetch("/api/dongs_with_stats")
  .then(res => res.json())
  .then(data => {
    const dongListEl = document.getElementById("dongList");
    dongListEl.innerHTML = "";
    data.dongs.forEach(d => {
      const item = document.createElement("button");
      item.type = "button";
      item.className = "list-group-item list-group-item-action d-flex justify-content-between align-items-center";
      item.innerHTML = `<span>${d.dong}</span><span class="badge bg-light text-dark">${d.reviewed}/${d.total}</span>`;
      item.addEventListener("click", () => {
        Array.from(dongListEl.children).forEach(c => c.classList.remove("active"));
        item.classList.add("active");
        loadBunjis(d.dong);
      });
      dongListEl.appendChild(item);
    });
  });

// --- ë²ˆì§€ ëª©ë¡ ---
function loadBunjis(dong) {
  const bunjiListEl = document.getElementById("bunjiList");
  bunjiListEl.innerHTML = '<div class="list-group-item">ë²ˆì§€ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
  fetch("/api/bunjis/" + encodeURIComponent(dong))
    .then(res => res.json())
    .then(data => {
      bunjiListEl.innerHTML = "";
      if (!data.bunjis || data.bunjis.length === 0) {
        bunjiListEl.innerHTML = '<div class="list-group-item">ë²ˆì§€ ì—†ìŒ</div>';
        return;
      }
      data.bunjis.forEach(b => {
        const item = document.createElement("button");
        item.type = "button";
        item.className = "list-group-item list-group-item-action";
        item.textContent = b;
        item.addEventListener("click", () => {
          Array.from(bunjiListEl.children).forEach(c => c.classList.remove("active"));
          item.classList.add("active");
          loadCompanies(dong, b);
        });
        bunjiListEl.appendChild(item);
      });
    });
}

// --- íšŒì‚¬ ëª©ë¡ ---
function loadCompanies(dong, bunji) {
  const companyListEl = document.getElementById("companyList");
  companyListEl.innerHTML = '<div class="list-group-item">íšŒì‚¬ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
  fetch(`/api/companies/${encodeURIComponent(dong)}/${encodeURIComponent(bunji)}`)
    .then(res => res.json())
    .then(data => {
      companyListEl.innerHTML = "";
      if (!data.companies || data.companies.length === 0) {
        companyListEl.innerHTML = '<div class="list-group-item">íšŒì‚¬ ì—†ìŒ</div>';
        return;
      }
      data.companies.forEach(c => {
        const wrapper = document.createElement("div");
        wrapper.className = "list-group-item";
        wrapper.innerHTML = `
          <div class="form-check">
            <input class="form-check-input me-1" type="checkbox" name="company_ids" value="${c.id}">
            <label class="form-check-label">${c.name} (ID=${c.id})</label>
          </div>`;
        wrapper.querySelector("input").addEventListener("change", () => {
          const checked = Array.from(companyListEl.querySelectorAll('input[name="company_ids"]:checked'));
          document.getElementById("mergeBtn").disabled = checked.length < 2;
          if (checked.length >= 1) {
            showCompanyInfo(checked[0].value);
            showSignInfo(checked[0].value);
          }
        });
        companyListEl.appendChild(wrapper);
      });
    });
}

// --- íšŒì‚¬ ì •ë³´ ---
function showCompanyInfo(company_id) {
  fetch(`/api/company/info/${company_id}`)
    .then(res => res.json())
    .then(data => {
      if (data.ok) {
        const info = data.info;
        document.getElementById("companyInfo").innerHTML = `
          <div class="card"><div class="card-body">
            <h5>${info.company_name} (ID ${info.company_id})</h5>
            <p>ë™: ${info.dong}, ë²ˆì§€: ${info.bunji}</p>
          </div></div>`;
      }
    });
}

// --- ê°„íŒ ì •ë³´ ---
function showSignInfo(company_id) {
  fetch(`/api/signs/${company_id}`)
    .then(res => res.json())
    .then(data => {
      const signInfoEl = document.getElementById("signInfo");
      signInfoEl.innerHTML = "";
      if (!data.ok || data.signs.length === 0) {
        signInfoEl.innerHTML = '<div class="text-muted">ê°„íŒ ì—†ìŒ <button class="btn btn-sm btn-outline-success">+</button></div>';
        return;
      }
      data.signs.forEach(sign => {
        const col = document.createElement("div");
        col.className = "col-12";
        col.innerHTML = `
          <div class="card h-100">
            <div class="card-body text-center">
              ${sign.thumb ? `<img src="${sign.thumb}" class="img-fluid mb-2 sign-thumb" data-iinfo="${sign.i_info}" style="cursor:pointer;">`
                           : `<button class="btn btn-outline-success w-100" data-iinfo="${sign.i_info}">+</button>`}
              <p class="small mb-1">ì¢…ë¥˜: ${sign.type || '-'}</p>
              <p class="small mb-1">ë¶„ë¥˜: ${sign.category || '-'}</p>
              <p class="small mb-0">í¬ê¸°: ${sign.width || 0} Ã— ${sign.height || 0}</p>
            </div>
          </div>`;
        signInfoEl.appendChild(col);
      });

      // ì¸ë„¤ì¼ í´ë¦­ ì‹œ Modal ì—´ê¸°
      document.querySelectorAll(".sign-thumb").forEach(img => {
        img.addEventListener("click", e => {
          const i_info = e.target.dataset.iinfo;
          currentIInfo = i_info;
          document.getElementById("modalImage").src = e.target.src;
          document.getElementById("modalIInfo").value = i_info;
          document.getElementById("historyBtn").href = `/sign/history/${i_info}`;
          new bootstrap.Modal(document.getElementById("signModal")).show();
        });
      });
    });
}

// --- ì´ë¯¸ì§€ êµì²´ ---
document.getElementById("replaceForm").addEventListener("submit", function(e) {
  e.preventDefault();
  const formData = new FormData(this);
  fetch("/api/sign/image_replace", { method: "POST", body: formData })
    .then(res => res.json())
    .then(data => {
      if (data.ok) {
        alert("ì´ë¯¸ì§€ êµì²´ ì™„ë£Œ!");
        bootstrap.Modal.getInstance(document.getElementById("signModal")).hide();
      } else {
        alert("êµì²´ ì‹¤íŒ¨: " + data.msg);
      }
    });
});

// --- Crop ê¸°ëŠ¥ ---
document.getElementById("cropBtn").addEventListener("click", () => {
  document.getElementById("cropImage").src = document.getElementById("modalImage").src;
  new bootstrap.Modal(document.getElementById("cropModal")).show();
  if (cropper) cropper.destroy();
  cropper = new Cropper(document.getElementById("cropImage"), {
    aspectRatio: 4/3,
    viewMode: 1
  });
});

// íšŒì „ ë²„íŠ¼
document.getElementById("rotateLeftBtn").addEventListener("click", () => {
  if (cropper) cropper.rotate(-90);
});
document.getElementById("rotateRightBtn").addEventListener("click", () => {
  if (cropper) cropper.rotate(90);
});

document.getElementById("cropSaveBtn").addEventListener("click", () => {
  if (cropper) {
    const canvas = cropper.getCroppedCanvas();
    canvas.toBlob(blob => {
      const formData = new FormData();
      formData.append("i_info", currentIInfo);
      formData.append("image", blob, "cropped.jpg");
      fetch("/api/sign/image_replace", { method: "POST", body: formData })
        .then(res => res.json())
        .then(data => {
          if (data.ok) {
            alert("í¬ë¡­ ì €ì¥ ì™„ë£Œ!");
            bootstrap.Modal.getInstance(document.getElementById("cropModal")).hide();
          }
        });
    });
  }
});

// --- ë™/ë²ˆì§€ ì´ë¯¸ì§€ ì°¾ê¸° ---
document.getElementById("findDongBtn").addEventListener("click", () => {
  const dong = document.querySelector("#dongList .active span")?.innerText;
  const bunji = document.querySelector("#bunjiList .active")?.innerText;
  if (!dong || !bunji) {
    alert("ë™ê³¼ ë²ˆì§€ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.");
    return;
  }
  fetch(`/static_images?dong=${encodeURIComponent(dong)}&bunji=${encodeURIComponent(bunji)}`)
    .then(res => res.json())
    .then(data => {
      const container = document.getElementById("dongImages");
      container.innerHTML = "";
      if (!data.images || data.images.length === 0) {
        container.innerHTML = "<p class='text-muted'>ê´€ë ¨ ì´ë¯¸ì§€ ì—†ìŒ</p>";
        return;
      }
      data.images.forEach(img => {
        const el = document.createElement("img");
        el.src = img;
        el.className = "img-fluid m-2";
        el.style.maxWidth = "200px";
        el.style.cursor = "pointer";
        el.addEventListener("click", () => {
          document.getElementById("modalImage").src = img;
          document.getElementById("modalIInfo").value = currentIInfo;
          bootstrap.Modal.getInstance(document.getElementById("dongModal")).hide();
        });
        container.appendChild(el);
      });
      new bootstrap.Modal(document.getElementById("dongModal")).show();
    });
});
</script>
{% endblock scripts %}
