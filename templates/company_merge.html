{% extends "base.html" %}
{% block title %}íšŒì‚¬/ê°„íŒ ë³‘í•© ë° ê´€ë¦¬{% endblock %}

{% block content %}
<div class="container-fluid py-5">
  <div class="row gx-3">

    <!-- 1ë‹¨: ë™ ì„ íƒ -->
    <div class="col-lg-3">
      <h5>ğŸ¢ ë™ ëª©ë¡</h5>
      <div id="dongList" class="list-group custom-list" style="max-height:300px; overflow-y:auto;">
        <div class="list-group-item">ë™ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>
    </div>

    <!-- 2ë‹¨: ë²ˆì§€ ì„ íƒ -->
    <div class="col-lg-3">
      <h5>ğŸ  ë²ˆì§€ ëª©ë¡</h5>
      <div id="bunjiList" class="list-group custom-list" style="max-height:300px; overflow-y:auto;">
        <div class="list-group-item">ë™ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.</div>
      </div>
    </div>

    <!-- 3ë‹¨: íšŒì‚¬ ëª©ë¡ + ì •ë³´ -->
    <div class="col-lg-3">
      <h5>ğŸ­ íšŒì‚¬ ëª©ë¡</h5>
      <div id="companyList" class="list-group custom-list" style="max-height:300px; overflow-y:auto;">
        <div class="list-group-item">ë™/ë²ˆì§€ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.</div>
      </div>

      <h6 class="mt-3">íšŒì‚¬ ì •ë³´</h6>
      <div id="companyInfo" style="max-height:220px; overflow-y:auto;">
        <div class="card"><div class="card-body"><p>íšŒì‚¬ ì„ íƒ ì‹œ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p></div></div>
      </div>

      <div class="mt-2">
        <button id="mergeBtn" class="btn btn-mint w-100" disabled>ì„ íƒëœ íšŒì‚¬ ë³‘í•©í•˜ê¸°</button>
      </div>
    </div>

    <!-- 4ë‹¨: ê°„íŒ ì •ë³´ -->
    <div class="col-lg-3">
      <h5>ğŸ“‹ ê°„íŒ ì •ë³´</h5>
      <div id="signInfo" class="row g-2" style="max-height:520px; overflow-y:auto;">
        <div class="text-muted">íšŒì‚¬ ì„ íƒ ì‹œ ê°„íŒ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
      </div>
    </div>

  </div>
</div>

<!-- íšŒì‚¬ í¸ì§‘ ëª¨ë‹¬ -->
<div class="modal fade" id="companyModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header"><h5 id="companyModalTitle" class="modal-title">íšŒì‚¬ ì •ë³´</h5></div>
      <div class="modal-body">
        <form id="companyForm">
          <input type="hidden" id="m_i_cpn">
          <div class="mb-2"><label class="form-label">íšŒì‚¬ëª…</label><input type="text" id="m_t_cpn" class="form-control"></div>
          <div class="mb-2"><label class="form-label">ë™</label><input type="text" id="m_t_add_3" class="form-control"></div>
          <div class="mb-2"><label class="form-label">ë²ˆì§€</label><input type="text" id="m_t_add_num" class="form-control" onblur="syncAddress('bunji')"></div>
          <div class="mb-2"><label class="form-label">ìƒì„¸</label><input type="text" id="m_t_add_2" class="form-control"></div>
          <div class="mb-2"><label class="form-label">ë„ë¡œëª… ì£¼ì†Œ</label><input type="text" id="m_t_road" class="form-control" onblur="syncAddress('road')"></div>
          <div class="mb-2"><label class="form-label">ì—°ë½ì²˜</label><input type="text" id="m_t_tel" class="form-control"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button id="btnCompDelete" class="btn btn-danger">ì‚­ì œ</button>
        <button id="btnCompSave" class="btn btn-success">ì €ì¥</button>
        <button class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
      </div>
    </div>
  </div>
</div>

<!-- ê°„íŒ ì´ë¯¸ì§€ ëª¨ë‹¬ -->
<div class="modal fade" id="signModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg"><div class="modal-content">
    <div class="modal-body text-center">
      <div class="mb-3">
        <div class="sign-thumb-wrap selected" style="display:inline-block;">
          <img id="modalImage" src="" class="img-fluid" alt="ê°„íŒ ì´ë¯¸ì§€">
        </div>
      </div>
      <form id="replaceForm" enctype="multipart/form-data" class="d-flex gap-2">
        <input type="file" name="image" accept="image/*" class="form-control">
        <input type="hidden" name="i_info" id="modalIInfo">
        <button type="submit" class="btn btn-primary">ì´ë¯¸ì§€ êµì²´</button>
      </form>
      <div class="d-flex justify-content-around mt-3">
        <a id="historyBtn" class="btn btn-outline-secondary btn-sm" target="_blank">ğŸ–¼ ì´ë¯¸ì§€ íˆìŠ¤í† ë¦¬</a>
        <button type="button" class="btn btn-outline-info btn-sm" id="cropBtn">âœ‚ ì´ë¯¸ì§€ ìˆ˜ì •</button>
        <button type="button" class="btn btn-outline-success btn-sm" id="findDongBtn">ğŸ” ë™/ë²ˆì§€ ì´ë¯¸ì§€ ì°¾ê¸°</button>
        <button type="button" class="btn btn-outline-warning btn-sm" id="saveRoadviewBtn">ğŸ›° ë¡œë“œë·° ì €ì¥</button>
      </div>
    </div>
  </div></div>
</div>

<!-- Crop ëª¨ë‹¬ -->
<div class="modal fade" id="cropModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl"><div class="modal-content">
    <div class="modal-body text-center"><img id="cropImage" src="" class="img-fluid" alt="í¬ë¡­ ëŒ€ìƒ"></div>
    <div class="modal-footer d-flex justify-content-between">
      <div>
        <button id="rotateLeftBtn" class="btn btn-outline-secondary btn-sm">âŸ² ì¢ŒíšŒì „</button>
        <button id="rotateRightBtn" class="btn btn-outline-secondary btn-sm">âŸ³ ìš°íšŒì „</button>
      </div>
      <button id="cropSaveBtn" class="btn btn-success">ì €ì¥</button>
    </div>
  </div></div>
</div>

<!-- ë™/ë²ˆì§€ ì´ë¯¸ì§€ ì„ íƒ -->
<div class="modal fade" id="dongModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg"><div class="modal-content">
    <div class="modal-body" id="dongImages" style="max-height:500px; overflow-y:auto;"></div>
  </div></div>
</div>
{% endblock content %}

{% block scripts %}
<style>
.sign-thumb-wrap { position: relative; display:inline-block; }
.sign-thumb-wrap.selected { outline: 3px solid #0d6efd; }
.sign-thumb-wrap.selected::after { content: ""; position: absolute; inset: 0; background: rgba(0,0,0,0.4); }
.custom-list .list-group-item.active, .custom-list .list-group-item:focus {
  background-color: #0d6efd !important; color: #fff !important;
}
.sign-meta { max-width: 460px; margin: 0 auto; text-align: left; }
.sign-meta .k { display:inline-block; width: 110px; color:#666; }
.sign-meta .v { font-weight: 600; }
</style>

<script src="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.css" rel="stylesheet"/>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const $ = (id) => document.getElementById(id);

  // ------- ìƒíƒœ -------
  let currentDong="", currentBunji="", currentCompanyId="", currentCompanyName="";
  let currentIInfo=null, cropper=null;
  let lastCompanyDetail=null; // íšŒì‚¬ ì¢Œí‘œ/ì£¼ì†Œ ì¬ì‚¬ìš©

  // ------- ë¼ë²¨ ë§¤í•‘(í•œê¸€) -------
  const SBF_MAP={"SBF01":"í—ˆê°€","SBF02":"ì‹ ê³ ","SBF03":"í—ˆê°€Â·ì‹ ê³  ë°°ì œ","SBF04":"ë¬´í—ˆê°€(ìš”ê±´êµ¬ë¹„)","SBF06":"ë¬´ì‹ ê³ (ìš”ê±´êµ¬ë¹„)","SBF08":"ìš”ê±´ë¶ˆë¹„(ìˆ˜ëŸ‰ì´ˆê³¼)","SBF09":"ìš”ê±´ë¶ˆë¹„(ìœ„ì¹˜/ì¥ì†Œ)","SBF10":"ìš”ê±´ë¶ˆë¹„(ê·œê²©)","SBF11":"ìš”ê±´ë¶ˆë¹„(í‘œì‹œë°©ë²•)"};
  const SBD_MAP={"SBD1":"ì „ê´‘(ê°„ì ‘ì¡°ëª…)","SBD2":"ë„¤ì˜¨ì‚¬ì¸","SBD3":"ì¼ë°˜ì „ê¸°","SBD4":"í™”ê³µ","SBD5":"ë¹„ì¡°ëª…","SBD6":"ê°„ì ‘ì¡°ëª…","SBD9":"ê¸°íƒ€ì¬ë£Œ"};
  const SBC_MAP={"SBC01":"ê°€ë¡œí˜•ê°„íŒ","SBC02":"ì„¸ë¡œí˜•ê°„íŒ","SBC03":"ëŒì¶œê°„íŒ","SBC05":"ì˜¥ìƒê°„íŒ","SBC06":"ì§€ì£¼ì´ìš©ê°„íŒ","SBC11":"ê³µê³µì‹œì„¤ë¬¼ì´ìš©","SBC13":"êµí†µìˆ˜ë‹¨ì´ìš©","SBC21":"í˜„ìˆ˜ë§‰ê²Œì‹œí‹€"};
  const kLabel=(m,c)=>(c&&m[c])||c||"-";

  // ------- ìœ í‹¸ -------
  async function fetchJSON(url){ const r=await fetch(url); if(!r.ok) throw new Error(`HTTP ${r.status} @ ${url}`); return r.json(); }
  async function postJSON(url,data){ const r=await fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)}); if(!r.ok) throw new Error(`HTTP ${r.status} @ ${url}`); return r.json(); }
  async function tryPost(urls,data){ for(const u of urls){ try{ const j=await postJSON(u,data); if(j && (j.ok || j.url || j.path)) return j; }catch(_){/*next*/} } throw new Error("ë¡œë“œë·° ì €ì¥ APIë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); }
  function setActive(listEl, btn){ [...listEl.children].forEach(c=>c.classList.remove("active")); btn.classList.add("active"); }
  // âœ… ë„¤ì´ë²„ ë§í¬: ì§€ë„ëŠ” bunjië§Œìœ¼ë¡œ ê²€ìƒ‰, ë¡œë“œë·°ëŠ” ì¢Œí‘œ ìš°ì„ (ì—†ìœ¼ë©´ bunji ê²€ìƒ‰ìœ¼ë¡œ í´ë°±)
  function buildNaverLinksFromDetail(detail) {
    // bunjiê°€ 'ê°ì²œë™ 1-13' ì²˜ëŸ¼ "ë™ + ë²ˆì§€"ë¥¼ í¬í•¨í•˜ë¯€ë¡œ ìš°ì„  ì‚¬ìš©
    const searchQuery =
      (detail && detail.bunji) ||
      detail?.road ||
      [detail?.dong, detail?.bunji, detail?.bunji2].filter(Boolean).join(" ") ||
      "";

    const enc = encodeURIComponent(searchQuery);

    // ì§€ë„ëŠ” í•­ìƒ bunji ê²€ìƒ‰ìœ¼ë¡œ ì—´ê¸°
    const mapLink = `https://map.naver.com/v5/search/${enc}`;

    // ë¡œë“œë·°ëŠ” ì¢Œí‘œê°€ ìˆìœ¼ë©´ ì¢Œí‘œë¡œ, ì—†ìœ¼ë©´ ì§€ë„ê²€ìƒ‰ ë§í¬ë¡œ ëŒ€ì²´
    let roadLink = mapLink;
    if (detail && detail.lat && detail.lng) {
      const { lat, lng } = detail;
      roadLink = `https://map.naver.com/v5/roadview/${lat},${lng}`;
    }

    return { mapLink, roadLink, searchQuery };
  }
  const first=(o,...keys)=>{ for(const k of keys){ const v=o?.[k]; if(v!=null && v!=="") return v; } return null; };

  // ë¬¼ë¦¬ ì¹˜ìˆ˜ + c_prt
  function extractPhysicalDims(o){
    const pickNum=(...keys)=>{ for(const k of keys){ const v=o?.[k]; if(v!=null && v!==""){ const n=Number(v); if(!Number.isNaN(n)) return n; } } return null; };
    let w_m=pickNum("width_m","w_m"), h_m=pickNum("height_m","h_m");
    let w_cm=pickNum("q_w","width_cm","w_cm","s_width","sign_width","width");
    let h_cm=pickNum("q_h","height_cm","h_cm","s_height","sign_height","height");
    let w_mm=pickNum("width_mm","w_mm"), h_mm=pickNum("height_mm","h_mm");
    const l_cm=pickNum("q_l","length_cm","l_cm","length");
    const t_cm=pickNum("q_s","thickness_cm","t_cm","thickness");
    let unit="cm", W=null, H=null;
    if(w_m!=null || h_m!=null){ unit="m"; W=w_m; H=h_m; }
    else if(w_cm!=null || h_cm!=null){ unit="cm"; W=w_cm; H=h_cm; }
    else if(w_mm!=null || h_mm!=null){ unit="mm"; W=w_mm; H=h_mm; }
    let area_m2=null;
    if(W!=null && H!=null){
      if(unit==="m") area_m2=W*H;
      else if(unit==="cm") area_m2=(W*H)/10000;
      else if(unit==="mm") area_m2=(W*H)/1_000_000;
    }
    const cprt=first(o,"c_prt","t_prt","q_prt","size_text","dimension","size_str","spec_text");
    return {unit,W,H,L:l_cm,T:t_cm,area_m2,cprt};
  }

  function renderOptionalAttrs(o){
    const kv=[];
    const place=first(o,"place","t_place","location","loc","pos","position");
    const floor=first(o,"floor","i_floor","q_floor","t_floor","lvl");
    const qty  =first(o,"qty","quantity","q_qty","count","cnt");
    const mat  =first(o,"material","t_material","mat");
    const text =first(o,"text","txt","t_txt","content","t_content");
    const note =first(o,"memo","note","remark","desc","description");
    if(place) kv.push(["ì„¤ì¹˜ìœ„ì¹˜",place]);
    if(floor) kv.push(["ì¸µ",floor]);
    if(qty)   kv.push(["ìˆ˜ëŸ‰",qty]);
    if(mat)   kv.push(["ì¬ì§ˆ",mat]);
    if(text)  kv.push(["ë¬¸êµ¬",text]);
    if(note)  kv.push(["ë¹„ê³ ",note]);
    return kv.map(([k,v])=>`<div><span class="k">${k}</span><span class="v">${v}</span></div>`).join("");
  }

  // ------- ë™/ë²ˆì§€/íšŒì‚¬ ëª©ë¡ ë¡œë”© -------
  async function loadDongs(){
    const el=document.getElementById("dongList");
    el.innerHTML="<div class='list-group-item'>ë™ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>";
    try{
      let data=await fetchJSON("/api/company/dongs_with_stats").catch(()=>null);
      if(!data) data=await fetchJSON("/api/company/dongs");
      const items=data.dongs || data || [];
      el.innerHTML="";
      items.forEach(x=>{
        const dong=typeof x==="string"?x:x.dong;
        const reviewed=(x.reviewed??"-"), total=(x.total??"-");
        const btn=document.createElement("button");
        btn.type="button";
        btn.className="list-group-item list-group-item-action d-flex justify-content-between";
        btn.innerHTML=`<span>${dong}</span><span class="badge bg-light text-dark">${reviewed}/${total}</span>`;
        btn.onclick=()=>{ setActive(el,btn); currentDong=dong; loadBunjis(dong); };
        el.appendChild(btn);
      });
    }catch(e){
      el.innerHTML=`<div class='list-group-item text-danger'>ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${e.message}</div>`;
    }
  }

  // ------- ë²ˆì§€ ëª©ë¡ -------
  async function loadBunjis(dong){
    const el=document.getElementById("bunjiList");
    el.innerHTML="<div class='list-group-item'>ë²ˆì§€ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>";
    try{
      const data=await fetchJSON(`/api/company/bunjis/${encodeURIComponent(dong)}`);
      const bunjis=data.bunjis||[];
      el.innerHTML="";
      bunjis.forEach(b=>{
        const btn=document.createElement("button");
        btn.type="button"; btn.className="list-group-item list-group-item-action"; btn.textContent=b;
        btn.onclick=()=>{ setActive(el,btn); currentBunji=b; loadCompanies(dong,b); };
        el.appendChild(btn);
      });
    }catch(e){
      el.innerHTML=`<div class='list-group-item text-danger'>ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${e.message}</div>`;
    }
  }

  async function loadCompanies(dong,bunji){
    const el=$("companyList");
    el.innerHTML="<div class='list-group-item'>íšŒì‚¬ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>";
    try{
      const data=await fetchJSON(`/api/company/companies/${encodeURIComponent(dong)}/${encodeURIComponent(bunji)}`);
      const comps=data.companies||[];
      el.innerHTML="";
      const selected=new Set();
      function updateMergeBtn(){ $("mergeBtn").disabled = selected.size<2; }

      comps.forEach(c=>{
        const row=document.createElement("div");
        row.className="list-group-item d-flex align-items-center gap-2";
        row.innerHTML=`<input type="checkbox" value="${c.id}">
                        <span class="flex-grow-1">${c.name} (ID=${c.id})</span>`;
        const cb=row.querySelector("input");
        cb.onchange=()=>{
          cb.checked?selected.add(c.id):selected.delete(c.id);
          updateMergeBtn();
          if(cb.checked){ currentCompanyId=c.id; currentCompanyName=c.name; showCompanyInfo(c.id, currentDong, c.name); showSignInfo(c.id); }
        };
        row.ondblclick=()=>openCompanyEditor(c.id,c.name);
        el.appendChild(row);
      });

      $("mergeBtn").onclick=async()=>{
        if(selected.size<2) return;
        const canonical=prompt("ëŒ€í‘œ íšŒì‚¬ëª…ì„ ì…ë ¥í•˜ì„¸ìš”(ë³‘í•© í›„ íšŒì‚¬ëª…):", currentCompanyName||"");
        if(!canonical) return;
        try{
          const res=await fetch("/api/merge_companies",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({selected_ids:[...selected], canonical_name:canonical})}).then(r=>r.json());
          if(res.ok){ alert(`ë³‘í•© ì™„ë£Œ (ëŒ€í‘œ i_cpn=${res.canonical_id})`); loadCompanies(currentDong,currentBunji); showSignInfo(res.canonical_id); }
          else alert("ë³‘í•© ì‹¤íŒ¨: "+(res.msg||""));
        }catch(e){ alert("ë³‘í•© ì˜¤ë¥˜: "+e.message); }
      };
    }catch(e){ el.innerHTML=`<div class='list-group-item text-danger'>ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${e.message}</div>`; }
  }

  // ------- íšŒì‚¬ ìƒì„¸ (ì‹ ë²„ì „ signboards API ê¸°ë°˜) -------
  async function fetchCompanyDetail(i_cpn, dong, companyName){
    try {
      const url = `/api/company/signboards?emd=${encodeURIComponent(dong)}&company=${encodeURIComponent(companyName)}&limit=1&sb_limit=1`;
      const j = await fetchJSON(url);

      if(j && j.ok && j.results && j.results.length > 0){
        const comp = j.results[0].company || {};
        return {
          company_id: comp.id || i_cpn,
          company_name: comp.company_name || companyName,
          dong: comp.dong || dong,
          bunji: comp.bunji,
          bunji2: comp.bunji2,
          road: comp.road || comp.address_road,
          tel: comp.tel,
          lat: comp.lat, lng: comp.lon
        };
      }
    } catch(e) {
      console.error("íšŒì‚¬ ìƒì„¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", e);
    }
    return null;
  }


  async function ensureCoords(d){
    if(d&&d.lat&&d.lng) return d;
    const q=d.road || [d.dong,d.bunji,d.bunji2].filter(Boolean).join(" ");
    if(!q) return d;
    try{ const g=await fetchJSON(`/api/geocode/sync?addr=${encodeURIComponent(q)}`); if(g){ d.lat=g.lat||g.y; d.lng=g.lng||g.x; } }catch(_){}
    return d;
  }
  function companyCardHTML(d, i_cpn) {
    const links = buildNaverLinksFromDetail(d); // <-- ë³€ê²½: detail ì „ì²´ ì „ë‹¬
    return `<div class='card'><div class='card-body'>
      <h5 class="d-flex align-items-center justify-content-between">
        <span>${d.company_name || "-"} <span class="text-muted">(ID:${d.company_id || i_cpn})</span></span>
        <span class="d-flex gap-2">
          <a href="${links.mapLink}" target="_blank" class="btn btn-outline-primary btn-sm">ë„¤ì´ë²„ ì§€ë„</a>
          <a href="${links.roadLink}" target="_blank" class="btn btn-outline-dark btn-sm">ë¡œë“œë·°</a>
          <button id="btnSaveRoadviewCompany" class="btn btn-outline-warning btn-sm" type="button">ğŸ›° ë¡œë“œë·° ì €ì¥</button>
        </span>
      </h5>
      <div>ë™: <b>${d.dong || "-"}</b></div>
      <div>ë²ˆì§€: <b>${d.bunji || "-"}</b> ${d.bunji2 ? `<span class="text-muted">(${d.bunji2})</span>` : ""}</div>
      <div>ë„ë¡œëª…: <b>${d.road || "-"}</b></div>
      <div>ì—°ë½ì²˜: <b>${d.tel || "-"}</b></div>
    </div></div>`;
  }

  async function showCompanyInfo(i_cpn, dong, companyName){
    let d = await fetchCompanyDetail(i_cpn, dong, companyName);
    if(!d){
      $("companyInfo").innerHTML = `<div class='card'><div class='card-body text-danger'>íšŒì‚¬ ì¡°íšŒ ì‹¤íŒ¨</div></div>`;
      return;
    }
    d = await ensureCoords(d);
    $("companyInfo").innerHTML = companyCardHTML(d, i_cpn);
  }

  // í¸ì§‘ ëª¨ë‹¬
  async function openCompanyEditor(i_cpn,name){
    const d=await fetchCompanyDetail(i_cpn);
    if(!d){ alert("íšŒì‚¬ ì¡°íšŒ ì‹¤íŒ¨"); return; }
    $("companyModalTitle").textContent=`íšŒì‚¬ ì •ë³´ â€” ${name} (i_cpn=${i_cpn})`;
    $("m_i_cpn").value=i_cpn; $("m_t_cpn").value=d.company_name||"";
    $("m_t_add_3").value=d.dong||""; $("m_t_add_num").value=d.bunji||"";
    $("m_t_add_2").value=d.bunji2||""; $("m_t_road").value=d.road||""; $("m_t_tel").value=d.tel||"";
    new bootstrap.Modal($("companyModal")).show();
  }
  window.openCompanyEditor=openCompanyEditor;

  $("btnCompSave")?.addEventListener("click", async()=>{
    const i_cpn=$("m_i_cpn").value;
    const fields={ t_cpn:$("m_t_cpn").value, t_add_3:$("m_t_add_3").value, t_add_num:$("m_t_add_num").value, t_add_2:$("m_t_add_2").value, t_road:$("m_t_road").value, t_tel:$("m_t_tel").value };
    const r=await fetch("/api/company/update",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({i_cpn,fields})}).then(r=>r.json()).catch(()=>null);
    if(r&&r.ok){ alert("ì €ì¥ ì™„ë£Œ"); bootstrap.Modal.getInstance($("companyModal")).hide(); if(currentDong&&currentBunji) loadCompanies(currentDong,currentBunji); showCompanyInfo(i_cpn); }
    else alert("ì €ì¥ ì‹¤íŒ¨");
  });
  $("btnCompDelete")?.addEventListener("click", async()=>{
    const i_cpn=$("m_i_cpn").value;
    if(!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    const r=await fetch("/api/company/delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({i_cpn})}).then(r=>r.json()).catch(()=>null);
    if(r&&r.ok){ alert("ì‚­ì œ ì™„ë£Œ"); bootstrap.Modal.getInstance($("companyModal")).hide(); if(currentDong&&currentBunji) loadCompanies(currentDong,currentBunji); }
    else alert("ì‚­ì œ ì‹¤íŒ¨");
  });
  window.syncAddress = async (type)=>{
    const query=(type==="road")?$("m_t_road").value:$("m_t_add_num").value;
    if(!query) return;
    const r=await fetch(`/api/geocode/sync?addr=${encodeURIComponent(query)}`).then(x=>x.json()).catch(()=>null);
    if(r&&r.ok){ if(r.dong) $("m_t_add_3").value=r.dong; if(r.road) $("m_t_road").value=r.road; }
  };

  // ------- ê°„íŒ ëª©ë¡ ë¡œë”© -------
  async function fetchCompanySigns(i_cpn){
    const tries=[`/api/sign/list/${encodeURIComponent(i_cpn)}`, `/api/signs/${encodeURIComponent(i_cpn)}`, `/api/sign/by_company/${encodeURIComponent(i_cpn)}`];
    for(const u of tries){
      try{ const j=await fetchJSON(u); const arr=j.signs||j.data||j||[]; if((Array.isArray(arr)&&arr.length)||(j.ok&&j.signs)) return {ok:true,signs:arr}; }catch(_){}
    }
    return {ok:false,signs:[]};
  }
  function normalizeSign(s){
    const i_info=s.i_info||s.ad_id||s.adidx||s.i_ad||s.i_img||s.id||"";
    const thumb=s.thumb||(i_info?(`/api/sign/image_blob/${i_info}`):"");
    const sbf=s.i_sc_sbf||s.sbf||s.sbf_code; const sbd=s.i_sc_sbd||s.sbd||s.sbd_code; const sbc=s.i_sc_sbc||s.sbc||s.sbc_code;
    const typeLabel=s.type||kLabel(SBD_MAP,sbd); const categLabel=s.category||kLabel(SBC_MAP,sbc);
    const dims=extractPhysicalDims(s);
    return {i_info,thumb,sbf,sbd,sbc,typeLabel,categLabel,dims,raw:s};
  }
  async function showSignInfo(i_cpn){
    const wrap=$("signInfo"); wrap.innerHTML="ê°„íŒ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
    const res=await fetchCompanySigns(i_cpn);
    if(!res.ok||!res.signs.length){ wrap.innerHTML="<div class='text-muted'>ê°„íŒ ì—†ìŒ</div>"; return; }
    const bust=Date.now();
    wrap.innerHTML="";
    res.signs.forEach(raw=>{
      const sn=normalizeSign(raw); const sbfLabel=kLabel(SBF_MAP,sn.sbf);
      const {unit,W,H,L,T,area_m2,cprt}=sn.dims;
      let sizeLines="";
      if(cprt) sizeLines+=`<div><span class="k">ê·œê²©(í‘œê¸°)</span><span class="v">${cprt}</span></div>`;
      if(W!=null||H!=null) sizeLines+=`<div><span class="k">ê·œê²©</span><span class="v">${W??"-"} Ã— ${H??"-"} ${unit}</span></div>`;
      if(typeof area_m2==="number") sizeLines+=`<div><span class="k">ë©´ì </span><span class="v">${(Math.round(area_m2*100)/100).toLocaleString()} mÂ²</span></div>`;
      if(L!=null) sizeLines+=`<div><span class="k">ê¸¸ì´</span><span class="v">${L} cm</span></div>`;
      if(T!=null) sizeLines+=`<div><span class="k">ë‘ê»˜</span><span class="v">${T} cm</span></div>`;
      const extra=renderOptionalAttrs(sn.raw);
      const imgSrc=sn.thumb?`${sn.thumb}${sn.thumb.includes('?')?'&':'?'}v=${bust}`:"";
      const card=document.createElement("div");
      card.className="col-12";
      card.innerHTML=`<div class="card h-100"><div class="card-body text-center">
        ${imgSrc?`<div class="sign-thumb-wrap"><img src="${imgSrc}" class="img-fluid mb-2 sign-thumb" data-iinfo="${sn.i_info}" style="cursor:pointer;"></div>`:`<div class="text-muted mb-2">ì´ë¯¸ì§€ ì—†ìŒ</div>`}
        <div class="sign-meta">
          <div><span class="k">ê°„íŒID</span><span class="v">${sn.i_info||"-"}</span></div>
          <div><span class="k">í—ˆê°€/ì‹ ê³ </span><span class="v">${sbfLabel}</span></div>
          <div><span class="k">ì¢…ë¥˜(ì¡°ëª…/ì¬ë£Œ)</span><span class="v">${sn.typeLabel||"-"}</span></div>
          <div><span class="k">ë¶„ë¥˜(ê°„íŒí˜•íƒœ)</span><span class="v">${sn.categLabel||"-"}</span></div>
          ${sizeLines}${extra}
        </div>
      </div></div>`;
      wrap.appendChild(card);
    });

    // ì¸ë„¤ì¼ í´ë¦­ â†’ ëª¨ë‹¬
    document.querySelectorAll(".sign-thumb").forEach(img=>{
      img.addEventListener("click",(e)=>{
        document.querySelectorAll(".sign-thumb-wrap").forEach(w=>w.classList.remove("selected"));
        e.target.closest(".sign-thumb-wrap")?.classList.add("selected");
        currentIInfo=e.target.dataset.iinfo;
        const base=e.target.src.split("?")[0];
        $("modalImage").src=`${base}?v=${Date.now()}`;
        $("modalIInfo").value=currentIInfo;
        $("historyBtn").href=`/api/sign/history/${currentIInfo}`;
        new bootstrap.Modal($("signModal")).show();
      });
    });
  }

  // ------- ì´ë¯¸ì§€ êµì²´/í¬ë¡­ -------
  $("replaceForm")?.addEventListener("submit", async (e)=>{
    e.preventDefault();
    const fd=new FormData(e.target);
    try{
      const d=await fetch("/api/sign/image_replace",{method:"POST",body:fd}).then(r=>r.json());
      if(d.ok){ alert("ì´ë¯¸ì§€ êµì²´ ì™„ë£Œ"); bootstrap.Modal.getInstance($("signModal")).hide(); if(currentCompanyId) showSignInfo(currentCompanyId); }
      else alert("ì‹¤íŒ¨: "+(d.msg||""));
    }catch(e){ alert("ì˜¤ë¥˜: "+e.message); }
  });
  $("cropBtn")?.addEventListener("click", ()=>{
    $("cropImage").src=$("modalImage").src;
    new bootstrap.Modal($("cropModal")).show();
    if(cropper) cropper.destroy();
    cropper=new Cropper($("cropImage"),{aspectRatio:4/3,viewMode:1});
  });
  $("rotateLeftBtn")?.addEventListener("click", ()=>{ if(cropper) cropper.rotate(-90); });
  $("rotateRightBtn")?.addEventListener("click", ()=>{ if(cropper) cropper.rotate(90); });
  $("cropSaveBtn")?.addEventListener("click", ()=>{
    if(!cropper) return;
    cropper.getCroppedCanvas().toBlob(async (blob)=>{
      const fd=new FormData(); fd.append("i_info",currentIInfo); fd.append("image",blob,"crop.jpg");
      try{
        const d=await fetch("/api/sign/image_replace",{method:"POST",body:fd}).then(r=>r.json());
        if(d.ok){ alert("í¬ë¡­ ì €ì¥ ì™„ë£Œ"); bootstrap.Modal.getInstance($("cropModal")).hide(); if(currentCompanyId) showSignInfo(currentCompanyId); }
      }catch(e){ alert("ì €ì¥ ì‹¤íŒ¨: "+e.message); }
    });
  });

  // ------- ë™/ë²ˆì§€ ì´ë¯¸ì§€ ì°¾ê¸° -------
  $("findDongBtn")?.addEventListener("click", async()=>{
    if(!currentDong||!currentBunji){ alert("ë™/ë²ˆì§€ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”."); return; }
    const cont=$("dongImages"); cont.innerHTML="ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦";
    try{
      const d=await fetchJSON(`/api/sign/static_images?dong=${encodeURIComponent(currentDong)}&bunji=${encodeURIComponent(currentBunji)}`);
      const imgs=d.images||[]; cont.innerHTML="";
      if(!imgs.length){ cont.innerHTML="<div class='text-muted'>ê´€ë ¨ ì´ë¯¸ì§€ ì—†ìŒ</div>"; }
      imgs.forEach(src=>{
        const el=document.createElement("img");
        el.src=src; el.className="img-fluid m-2"; el.style.maxWidth="200px"; el.style.cursor="pointer";
        el.onclick=()=>{ $("modalImage").src=src; bootstrap.Modal.getInstance($("dongModal")).hide(); };
        cont.appendChild(el);
      });
      new bootstrap.Modal($("dongModal")).show();
    }catch(e){ cont.innerHTML=`<span class='text-danger'>ì˜¤ë¥˜: ${e.message}</span>`; }
  });

  // ------- (ì‹ ê·œ) ê°„íŒ/íšŒì‚¬ ë¡œë“œë·° ì €ì¥ ë²„íŠ¼ -------
  $("saveRoadviewBtn")?.addEventListener("click", async ()=>{
    if(!lastCompanyDetail || !lastCompanyDetail.lat || !lastCompanyDetail.lng){
      alert("íšŒì‚¬ ì¢Œí‘œê°€ ì—†ì–´ ë¡œë“œë·°ë¥¼ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return;
    }
    const fullAddr= lastCompanyDetail.road || [lastCompanyDetail.dong,lastCompanyDetail.bunji,lastCompanyDetail.bunji2].filter(Boolean).join(" ");
    try{
      const resp=await tryPost(
        ["/api/illegal/roadview/save","/api/illegal/roadview/snapshot","/api/illegal/save_roadview","/api/sign/roadview/save"],
        { lat:lastCompanyDetail.lat, lng:lastCompanyDetail.lng, addr:fullAddr, i_cpn:currentCompanyId, i_info:currentIInfo }
      );
      alert("ë¡œë“œë·° ì €ì¥ ì™„ë£Œ" + (resp.path?`\nì €ì¥ê²½ë¡œ: ${resp.path}`:""));
    }catch(e){ alert("ë¡œë“œë·° ì €ì¥ ì‹¤íŒ¨: "+e.message); }
  });

  // ì´ˆê¸° ë¡œë“œ
  loadDongs();
});
</script>
{% endblock scripts %}
